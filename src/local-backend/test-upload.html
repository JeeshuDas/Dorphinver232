<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dorphin Backend Tester</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    
    .header h1 {
      font-size: 32px;
      margin-bottom: 10px;
    }
    
    .header p {
      opacity: 0.9;
      font-size: 16px;
    }
    
    .content {
      padding: 30px;
    }
    
    .section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f7f7f7;
      border-radius: 10px;
    }
    
    .section h2 {
      margin-bottom: 15px;
      color: #333;
      font-size: 20px;
    }
    
    .upload-area {
      border: 3px dashed #667eea;
      border-radius: 10px;
      padding: 40px;
      text-align: center;
      background: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .upload-area:hover {
      border-color: #764ba2;
      background: #f9f9f9;
    }
    
    .upload-area.dragging {
      border-color: #764ba2;
      background: #e8e8ff;
    }
    
    input[type="file"] {
      display: none;
    }
    
    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      margin: 5px;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn-secondary {
      background: #6c757d;
    }
    
    .status {
      margin-top: 15px;
      padding: 15px;
      border-radius: 8px;
      font-size: 14px;
    }
    
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    .videos-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    .video-card {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .video-card video {
      width: 100%;
      height: 150px;
      object-fit: cover;
      background: #000;
    }
    
    .video-info {
      padding: 10px;
    }
    
    .video-info .filename {
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
      word-break: break-all;
    }
    
    .video-info .size {
      font-size: 11px;
      color: #999;
    }
    
    .delete-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 5px 15px;
      border-radius: 5px;
      font-size: 12px;
      cursor: pointer;
      margin-top: 5px;
    }
    
    .delete-btn:hover {
      background: #c82333;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    .stat-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }
    
    .stat-card .value {
      font-size: 24px;
      font-weight: 700;
      color: #667eea;
      margin-bottom: 5px;
    }
    
    .stat-card .label {
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üé¨ Dorphin Backend Tester</h1>
      <p>Test your local Node.js + Express video upload backend</p>
    </div>
    
    <div class="content">
      <!-- Health Check Section -->
      <div class="section">
        <h2>üè• Health Check</h2>
        <button class="btn" onclick="checkHealth()">Check Server Status</button>
        <div id="health-status"></div>
      </div>
      
      <!-- Upload Section -->
      <div class="section">
        <h2>üì§ Upload Video</h2>
        <div class="upload-area" id="upload-area" onclick="document.getElementById('file-input').click()">
          <p style="font-size: 48px; margin-bottom: 10px;">üìπ</p>
          <p style="color: #667eea; font-weight: 600; margin-bottom: 5px;">Click to select video or drag & drop</p>
          <p style="color: #999; font-size: 14px;">Maximum file size: 500MB</p>
          <p style="color: #999; font-size: 12px; margin-top: 10px;">Supported: MP4, MOV, AVI, MKV, WebM</p>
        </div>
        <input type="file" id="file-input" accept="video/*" onchange="uploadVideo(this.files[0])">
        <div id="upload-status"></div>
      </div>
      
      <!-- Videos List Section -->
      <div class="section">
        <h2>üìã Uploaded Videos</h2>
        <button class="btn" onclick="loadVideos()">Refresh List</button>
        <button class="btn btn-secondary" onclick="getStorageInfo()">Storage Info</button>
        <div id="videos-list"></div>
      </div>
      
      <!-- Storage Info Section -->
      <div class="section" style="display: none;" id="storage-section">
        <h2>üíæ Storage Information</h2>
        <div id="storage-stats"></div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = 'http://localhost:5000';
    
    // Drag and drop functionality
    const uploadArea = document.getElementById('upload-area');
    
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragging');
    });
    
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragging');
    });
    
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragging');
      const file = e.dataTransfer.files[0];
      if (file && file.type.startsWith('video/')) {
        uploadVideo(file);
      } else {
        showStatus('upload-status', 'Please drop a video file', 'error');
      }
    });
    
    // Check server health
    async function checkHealth() {
      const statusDiv = document.getElementById('health-status');
      statusDiv.innerHTML = '<div class="status info">Checking server...<span class="loading"></span></div>';
      
      try {
        const response = await fetch(`${API_URL}/health`);
        const data = await response.json();
        
        if (data.status === 'running') {
          statusDiv.innerHTML = `
            <div class="status success">
              <strong>‚úÖ Server is running!</strong><br>
              Uptime: ${Math.floor(data.uptime)} seconds<br>
              Timestamp: ${new Date(data.timestamp).toLocaleString()}
            </div>
          `;
        } else {
          statusDiv.innerHTML = '<div class="status error">‚ùå Server is not responding properly</div>';
        }
      } catch (error) {
        statusDiv.innerHTML = `
          <div class="status error">
            <strong>‚ùå Cannot connect to server</strong><br>
            Make sure the server is running on port 5000<br>
            Error: ${error.message}
          </div>
        `;
      }
    }
    
    // Upload video
    async function uploadVideo(file) {
      if (!file) return;
      
      const statusDiv = document.getElementById('upload-status');
      statusDiv.innerHTML = '<div class="status info">Uploading video...<span class="loading"></span></div>';
      
      const formData = new FormData();
      formData.append('video', file);
      
      try {
        const response = await fetch(`${API_URL}/upload`, {
          method: 'POST',
          body: formData,
        });
        
        const data = await response.json();
        
        if (data.success) {
          const sizeMB = (data.size / 1024 / 1024).toFixed(2);
          statusDiv.innerHTML = `
            <div class="status success">
              <strong>‚úÖ Upload successful!</strong><br>
              Filename: ${data.filename}<br>
              Size: ${sizeMB} MB<br>
              URL: <a href="${data.fileUrl}" target="_blank">${data.fileUrl}</a>
            </div>
          `;
          
          // Auto-refresh videos list
          loadVideos();
        } else {
          statusDiv.innerHTML = `<div class="status error">‚ùå Upload failed: ${data.error}</div>`;
        }
      } catch (error) {
        statusDiv.innerHTML = `<div class="status error">‚ùå Upload error: ${error.message}</div>`;
      }
      
      // Clear file input
      document.getElementById('file-input').value = '';
    }
    
    // Load videos list
    async function loadVideos() {
      const listDiv = document.getElementById('videos-list');
      listDiv.innerHTML = '<div class="status info">Loading videos...<span class="loading"></span></div>';
      
      try {
        const response = await fetch(`${API_URL}/videos`);
        const data = await response.json();
        
        if (data.success && data.videos.length > 0) {
          const videosHTML = data.videos.map(video => {
            const sizeMB = (video.size / 1024 / 1024).toFixed(2);
            return `
              <div class="video-card">
                <video src="${video.fileUrl}" controls></video>
                <div class="video-info">
                  <div class="filename">${video.filename}</div>
                  <div class="size">Size: ${sizeMB} MB</div>
                  <button class="delete-btn" onclick="deleteVideo('${video.filename}')">üóëÔ∏è Delete</button>
                </div>
              </div>
            `;
          }).join('');
          
          listDiv.innerHTML = `
            <div class="status success">Found ${data.count} video(s)</div>
            <div class="videos-grid">${videosHTML}</div>
          `;
        } else if (data.success && data.videos.length === 0) {
          listDiv.innerHTML = '<div class="status info">No videos uploaded yet. Upload your first video above!</div>';
        } else {
          listDiv.innerHTML = `<div class="status error">‚ùå Failed to load videos</div>`;
        }
      } catch (error) {
        listDiv.innerHTML = `<div class="status error">‚ùå Error loading videos: ${error.message}</div>`;
      }
    }
    
    // Delete video
    async function deleteVideo(filename) {
      if (!confirm(`Delete ${filename}?`)) return;
      
      try {
        const response = await fetch(`${API_URL}/videos/${filename}`, {
          method: 'DELETE',
        });
        
        const data = await response.json();
        
        if (data.success) {
          alert('‚úÖ Video deleted successfully!');
          loadVideos();
        } else {
          alert(`‚ùå Delete failed: ${data.error}`);
        }
      } catch (error) {
        alert(`‚ùå Delete error: ${error.message}`);
      }
    }
    
    // Get storage info
    async function getStorageInfo() {
      const storageSection = document.getElementById('storage-section');
      const statsDiv = document.getElementById('storage-stats');
      
      storageSection.style.display = 'block';
      statsDiv.innerHTML = '<div class="status info">Loading storage info...<span class="loading"></span></div>';
      
      try {
        const response = await fetch(`${API_URL}/storage-info`);
        const data = await response.json();
        
        if (data.success) {
          statsDiv.innerHTML = `
            <div class="stats">
              <div class="stat-card">
                <div class="value">${data.totalFiles}</div>
                <div class="label">Total Files</div>
              </div>
              <div class="stat-card">
                <div class="value">${data.totalSizeMB}</div>
                <div class="label">Total MB</div>
              </div>
              <div class="stat-card">
                <div class="value">${data.totalSizeGB}</div>
                <div class="label">Total GB</div>
              </div>
            </div>
            <div class="status info" style="margin-top: 15px;">
              <strong>Uploads Path:</strong><br>
              ${data.uploadsPath}
            </div>
          `;
        } else {
          statsDiv.innerHTML = `<div class="status error">‚ùå Failed to load storage info</div>`;
        }
      } catch (error) {
        statsDiv.innerHTML = `<div class="status error">‚ùå Error: ${error.message}</div>`;
      }
    }
    
    function showStatus(elementId, message, type) {
      const element = document.getElementById(elementId);
      element.innerHTML = `<div class="status ${type}">${message}</div>`;
    }
    
    // Auto-check health on page load
    window.addEventListener('load', () => {
      checkHealth();
      loadVideos();
    });
  </script>
</body>
</html>
